# AI Music Maker 多端适配任务计划

> 创建时间：2025-01-06
> 前置依赖：Web V0.6 完成
> 目标：后端支持多端，小程序可接入
> 状态标记：⬜ 未开始 | 🔄 进行中 | ✅ 完成 | ❌ 阻塞

---

## 角色定义

| 角色 | 职责 | 技能要求 |
|------|------|---------|
| **后端开发** | API 开发、数据库、Worker | NestJS, PostgreSQL, Redis |
| **Web 前端** | Web 端适配改造 | Next.js, React |
| **小程序开发** | 微信小程序开发 | 微信小程序, Taro/原生 |
| **QA** | 测试验收 | 多端测试, 接口测试 |
| **DevOps** | 部署配置 | Docker, CI/CD |

---

## Phase 1：后端多端基础设施（V0.7）

### 1.1 用户身份体系改造

**认领角色**：后端开发
**预估工作量**：中等
**依赖**：无

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| Identity 数据模型设计 | ⬜ | Prisma Schema 新增 User + Identity 表，支持 1:N 关系 | 迁移脚本可执行，表结构正确 |
| device_id 迁移脚本 | ⬜ | 将现有 Device 表数据迁移到 User + Identity | 旧数据无损迁移，track 归属正确 |
| AuthModule 重构 | ⬜ | 抽象认证逻辑，支持多 provider | 单元测试覆盖 web/wechat 两种 |
| 匿名登录 API | ⬜ | `POST /api/v1/auth/anonymous` | Web 端无感切换，token 正常签发 |
| JWT 签发与校验 | ⬜ | 统一 token 结构，含 user_id + platform | Guards 正确拦截未授权请求 |
| 身份绑定 API | ⬜ | `POST /api/v1/auth/bindIdentity` | 同一用户可绑定多个 identity |

**测试用例**（QA 认领）：
- [ ] 新用户首次访问自动创建 User + Identity
- [ ] 同一 device_id 多次请求返回同一 user_id
- [ ] Token 过期后返回 AUTH_EXPIRED 错误码
- [ ] 不同 platform 的请求正确记录到 Identity

---

### 1.2 微信登录集成

**认领角色**：后端开发
**预估工作量**：小
**依赖**：1.1 完成

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| 微信开放平台配置 | ⬜ | 注册小程序，获取 appid/secret | 配置到环境变量 |
| code2session 封装 | ⬜ | 调用微信 API 换取 openid/session_key | 错误处理完善，重试机制 |
| 微信登录 API | ⬜ | `POST /api/v1/auth/wechat` | 返回 access_token，创建 Identity |
| unionid 处理 | ⬜ | 支持关联公众号/开放平台同主体 | unionid 存储到 provider_meta |

**测试用例**（QA 认领）：
- [ ] 有效 code 换取 token 成功
- [ ] 无效 code 返回 AUTH_PROVIDER_ERROR
- [ ] 同一 openid 多次登录返回同一 user_id
- [ ] unionid 正确存储

---

### 1.3 音频代理上传

**认领角色**：后端开发
**预估工作量**：中等
**依赖**：无

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| 代理上传 API | ⬜ | `POST /api/v1/assets/audio/upload` multipart | 10MB 以内文件正常上传 |
| 流式转发 S3 | ⬜ | 不落盘，直接 stream 到 S3 | 内存占用可控 |
| 文件大小限制 | ⬜ | 配置 MAX_UPLOAD_SIZE，超限返回错误 | 超限返回 UPLOAD_TOO_LARGE |
| 格式校验 | ⬜ | 校验 MIME type，拒绝非音频 | 非音频返回 UPLOAD_FORMAT_INVALID |
| 上传进度（可选） | ⬜ | 支持分块上传进度回调 | 大文件上传有进度反馈 |

**测试用例**（QA 认领）：
- [ ] 1MB mp3 文件上传成功
- [ ] 10MB 文件上传成功
- [ ] 15MB 文件返回 UPLOAD_TOO_LARGE
- [ ] txt 文件返回 UPLOAD_FORMAT_INVALID
- [ ] 并发 5 个上传请求正常处理

---

### 1.4 分享机制扩展

**认领角色**：后端开发
**预估工作量**：中等
**依赖**：微信开放平台配置

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| Share 表扩展 | ⬜ | 新增 share_type, qrcode_asset_id, scheme_url | 迁移脚本可执行 |
| 小程序码生成 | ⬜ | 调用微信 getUnlimitedQRCode API | 返回图片 buffer |
| 小程序码存储 | ⬜ | 上传到 S3 /qrcode/ 目录 | CDN 可访问 |
| 分享 API 扩展 | ⬜ | 支持 share_types 参数，同时生成多种 | 返回多个 URL |
| Scheme 生成 | ⬜ | 生成微信 URL Scheme | 格式正确可跳转 |

**测试用例**（QA 认领）：
- [ ] 请求 ["link"] 只返回 link_url
- [ ] 请求 ["link", "wxcode"] 返回两个 URL
- [ ] 小程序码图片可正常访问
- [ ] Scheme URL 格式正确

---

### 1.5 平台标识与埋点

**认领角色**：后端开发
**预估工作量**：小
**依赖**：无

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| 请求中间件 | ⬜ | 解析 X-Platform, X-App-Version Header | 注入到请求上下文 |
| Langfuse 平台字段 | ⬜ | trace metadata 增加 platform 字段 | Langfuse 可按平台筛选 |
| 埋点扩展 | ⬜ | 现有埋点增加 platform 维度 | 埋点数据含 platform |

**测试用例**（QA 认领）：
- [ ] 不传 X-Platform 默认 web
- [ ] 传 wxmp 正确记录
- [ ] Langfuse trace 可按 platform 过滤

---

## Phase 2：Web 端适配（V0.7）

**认领角色**：Web 前端
**预估工作量**：小
**依赖**：Phase 1.1 完成

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| 登录流程切换 | ⬜ | 从 device_id 直传改为调用 /auth/anonymous | 用户无感知 |
| Token 存储 | ⬜ | localStorage 存储 access_token | 刷新页面保持登录 |
| 请求拦截器 | ⬜ | axios/fetch 自动带 Authorization Header | 所有请求带 token |
| Token 刷新 | ⬜ | 401 时自动刷新 token | 用户无感知续期 |
| Platform Header | ⬜ | 所有请求带 X-Platform: web | 后端正确识别 |

**测试用例**（QA 认领）：
- [ ] 首次访问自动登录成功
- [ ] 清除 localStorage 后重新登录
- [ ] Token 过期后自动刷新
- [ ] 作品数据正确归属

---

## Phase 3：微信小程序开发（V1.0-wxmp）

### 3.1 项目搭建

**认领角色**：小程序开发
**预估工作量**：小
**依赖**：无

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| 项目初始化 | ⬜ | 选型：原生 / Taro / uni-app | 项目可运行 |
| 目录结构 | ⬜ | pages / components / utils / api | 结构清晰 |
| 请求封装 | ⬜ | wx.request 封装，统一错误处理 | 支持 token 注入 |
| 登录流程 | ⬜ | wx.login → 后端换 token → 存储 | 启动时自动登录 |

---

### 3.2 核心页面

**认领角色**：小程序开发
**预估工作量**：大
**依赖**：3.1 完成

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| 首页/创作页 | ⬜ | 录音 Tab + 上传 Tab | 布局与 Web 一致 |
| 录音组件 | ⬜ | RecorderManager 封装，波形展示 | 录音可播放预览 |
| 上传组件 | ⬜ | wx.chooseMessageFile 选择音频 | 支持从聊天/本地选择 |
| 风格选择 | ⬜ | 风格输入 + 高级选项折叠 | 必填校验 |
| 生成中页 | ⬜ | 轮询 job 状态，进度展示 | 可离开页面 |
| 结果页 | ⬜ | A/B 播放器 + 选主版本 | 单实例互斥播放 |
| 作品库页 | ⬜ | 列表展示，支持播放/分享/删除 | 分页加载 |
| 分享页 | ⬜ | 接收 share_code 参数，展示播放 | 支持转发 |

---

### 3.3 音频播放器

**认领角色**：小程序开发
**预估工作量**：中等
**依赖**：3.1 完成

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| InnerAudioContext 封装 | ⬜ | 统一播放控制接口 | play/pause/seek/stop |
| A/B 互斥控制 | ⬜ | 播 A 自动停 B | 同一时间只有一个在播 |
| 进度条 | ⬜ | 实时更新进度，支持拖动 | 拖动后从新位置播放 |
| 后台播放 | ⬜ | 支持小程序切后台继续播放 | 需配置 requiredBackgroundModes |
| 播放状态同步 | ⬜ | 页面间播放状态同步 | 切页面不中断播放 |

---

### 3.4 分享功能

**认领角色**：小程序开发
**预估工作量**：小
**依赖**：Phase 1.4 完成

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| 转发好友 | ⬜ | onShareAppMessage 配置 | 好友可打开小程序 |
| 分享朋友圈 | ⬜ | onShareTimeline 配置 | 朋友圈可见卡片 |
| 生成海报 | ⬜ | Canvas 绘制 + 小程序码 | 可保存到相册 |
| 复制链接 | ⬜ | 复制 Web 分享链接 | 剪贴板复制成功 |

---

## Phase 4：联调与测试

**认领角色**：QA
**预估工作量**：中等
**依赖**：Phase 1-3 完成

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| 接口联调 | ⬜ | 小程序调用后端 API 全链路 | 无 500 错误 |
| 跨端数据同步 | ⬜ | Web 创建 → 小程序可见，反之亦然 | 数据实时同步 |
| 分享互通 | ⬜ | Web 分享 → 小程序打开，反之亦然 | 分享链路通畅 |
| 性能测试 | ⬜ | 代理上传压测，并发测试 | P99 < 3s |
| 兼容性测试 | ⬜ | iOS/Android 多机型测试 | 主流机型通过 |
| 安全测试 | ⬜ | Token 伪造、越权访问测试 | 无安全漏洞 |

---

## Phase 5：上线准备

**认领角色**：DevOps + 产品
**预估工作量**：中等
**依赖**：Phase 4 完成

| 任务 | 状态 | 详细描述 | 验收标准 |
|------|------|---------|---------|
| 小程序备案 | ⬜ | ICP 备案、小程序备案 | 备案通过 |
| 类目资质 | ⬜ | 音视频类目申请 | 类目审核通过 |
| 内容安全接入 | ⬜ | 集成腾讯云/阿里云内容安全 | 违规内容可识别 |
| 隐私协议 | ⬜ | 用户隐私协议、用户协议 | 合规检查通过 |
| 提审材料 | ⬜ | 准备审核材料、测试账号 | 材料齐全 |
| 灰度发布 | ⬜ | 小流量灰度测试 | 无线上问题 |
| 正式发布 | ⬜ | 全量发布 | 用户可正常使用 |

---

## 任务依赖图

```
Phase 1.1 (Identity) ──┬──► Phase 1.2 (微信登录) ──┐
                       │                           │
                       └──► Phase 2 (Web适配) ─────┤
                                                   │
Phase 1.3 (代理上传) ─────────────────────────────┼──► Phase 3 (小程序)
                                                   │
Phase 1.4 (分享扩展) ─────────────────────────────┤
                                                   │
Phase 1.5 (平台标识) ─────────────────────────────┘
                                                   │
                                                   ▼
                                            Phase 4 (联调测试)
                                                   │
                                                   ▼
                                            Phase 5 (上线)
```

---

## 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 微信审核不通过 | 上线延期 | 提前准备资质，预留 2 周审核时间 |
| 小程序录音兼容性 | 功能受限 | 后端 FFmpeg 兜底转码 |
| 内容安全拦截 | 用户体验差 | 生成前预检，拦截后给明确提示 |
| 代理上传性能瓶颈 | 上传慢 | 限制文件大小，必要时增加服务器 |

---

## 更新日志

| 日期 | 变更 |
|------|------|
| 2025-01-06 | 初始化多端适配任务计划 |
